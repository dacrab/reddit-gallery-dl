<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reddit Gallery DL</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        :root {
            --bs-primary:           #FF4500;
            --bs-primary-rgb:       255, 69, 0;
            --bs-link-color:        #FF4500;
            --bs-link-color-rgb:    255, 69, 0;
            --transition:           all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        body { min-height: 100vh; display: flex; flex-direction: column; }

        /* Navbar */
        .btn-icon {
            width: 36px; height: 36px; padding: 0;
            display: inline-flex; align-items: center; justify-content: center;
            border-radius: 50%;
        }

        /* Hero */
        .hero-section { padding: 4rem 1rem; transition: padding 0.4s ease; }
        .hero-section.compact { padding: 1rem; border-bottom: 1px solid var(--bs-border-color); }

        /* Search */
        .search-container { max-width: 860px; margin: 0 auto; position: relative; }
        .search-input {
            border-radius: 50px;
            padding: 1rem 6.5rem 1rem 1.5rem;
            border: 2px solid var(--bs-border-color);
            font-size: 1.1rem;
            transition: var(--transition);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,.1);
        }
        .search-input:focus {
            border-color: #FF4500;
            box-shadow: 0 0 0 4px rgba(255,69,0,.15);
        }
        .search-btn {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            border-radius: 50%; width: 42px; height: 42px;
            padding: 0; display: inline-flex; align-items: center; justify-content: center;
        }
        .paste-btn {
            position: absolute; right: 58px; top: 50%; transform: translateY(-50%);
            border-radius: 50%; width: 36px; height: 36px;
            border: 1px solid var(--bs-border-color); background: transparent;
            cursor: pointer; display: inline-flex; align-items: center; justify-content: center;
            font-size: 1rem; color: var(--bs-secondary-color);
            opacity: .6; transition: var(--transition);
        }
        .paste-btn:hover { opacity: 1; border-color: var(--bs-secondary-color); }
        .paste-btn.success { color: var(--bs-success); border-color: var(--bs-success); opacity: 1; }

        /* Gallery */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem; padding: 2rem 0;
        }
        .image-card {
            position: relative; border-radius: 12px; overflow: hidden;
            cursor: pointer; aspect-ratio: 1;
            background: var(--bs-tertiary-bg);
            border: 2px solid transparent;
            transition: var(--transition);
        }
        .image-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,.1); }
        .image-card.selected { border-color: #FF4500; transform: scale(0.98); }
        .image-card.selected::after {
            content: ''; position: absolute; inset: 0;
            background: rgba(255,69,0,.15); pointer-events: none;
        }
        .image-card img { width: 100%; height: 100%; object-fit: cover; }
        .image-card input[type="checkbox"] { display: none; }

        .check-badge {
            position: absolute; top: 10px; right: 10px;
            width: 28px; height: 28px; border-radius: 50%;
            background: #FF4500; color: white;
            display: inline-flex; align-items: center; justify-content: center;
            opacity: 0; transform: scale(.8); transition: var(--transition); z-index: 1;
        }
        .image-card.selected .check-badge { opacity: 1; transform: scale(1); }

        .card-actions {
            position: absolute; bottom: 0; left: 0; right: 0;
            padding: 1rem; background: linear-gradient(to top, rgba(0,0,0,.8), transparent);
            opacity: 0; transition: var(--transition);
            display: flex; justify-content: flex-end; gap: .5rem;
        }
        .image-card:hover .card-actions { opacity: 1; }

        /* Action bar */
        .action-bar {
            position: fixed; bottom: 2rem; left: 50%;
            transform: translateX(-50%) translateY(150%);
            background: var(--bs-body-bg); border: 1px solid var(--bs-border-color);
            padding: .75rem 1rem; border-radius: 100px;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,.3);
            display: flex; align-items: center; gap: .75rem;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000; max-width: 95vw;
        }
        @media (min-width: 576px) { .action-bar { padding: .75rem 1.5rem; gap: 1rem; max-width: 90vw; } }
        .action-bar.visible { transform: translateX(-50%) translateY(0); }

        /* Bootstrap overrides */
        .btn-primary {
            --bs-btn-bg:               #FF4500;
            --bs-btn-border-color:     #FF4500;
            --bs-btn-hover-bg:         #CC3700;
            --bs-btn-hover-border-color: #CC3700;
            --bs-btn-active-bg:        #CC3700;
            --bs-btn-focus-shadow-rgb: 255, 69, 0;
        }
        .btn-outline-secondary:hover, .btn-outline-secondary:focus {
            background: rgba(255,69,0,.1); border-color: #FF4500; color: #FF4500;
        }
        .alert-success { --bs-alert-color: #46d160; --bs-alert-bg: rgba(70,209,96,.1); --bs-alert-border-color: rgba(70,209,96,.3); }

        /* Loading overlay */
        #loadingOverlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,.5); backdrop-filter: blur(5px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;">
        <span class="visually-hidden">Loading…</span>
    </div>
</div>

<nav class="navbar px-3 py-2">
    <a class="navbar-brand fw-bold d-flex align-items-center gap-2" href="/">
        <img src="/static/favicon.svg" width="28" height="28" alt="Logo">
        Gallery<span class="text-primary">DL</span>
    </a>
    <div class="ms-auto d-flex align-items-center gap-2">
        <a href="https://github.com/dacrab/reddit-gallery-dl" target="_blank" rel="noopener"
           class="btn btn-outline-secondary btn-icon border-0" title="GitHub" aria-label="GitHub">
            <i class="bi bi-github"></i>
        </a>
        <button class="btn btn-outline-secondary btn-icon border-0" onclick="toggleTheme()"
                id="themeBtn" title="Toggle theme" aria-label="Toggle theme">
            <i class="bi bi-moon-stars-fill"></i>
        </button>
    </div>
</nav>

<main class="flex-grow-1">

    <section class="hero-section {{ if .Images }}compact{{ end }}">
        <div class="container text-center">
            {{ if not .Images }}
            <h1 class="display-4 fw-bold mb-3">Download Reddit Galleries in Seconds</h1>
            <p class="text-secondary mb-5 fs-5">Paste a Reddit link below to view and download high-quality images.</p>
            {{ end }}

            <form action="/" method="POST" class="search-container" onsubmit="showLoading()">
                <input class="form-control search-input" type="text" name="url" id="urlInput"
                       placeholder="Paste a Reddit URL…"
                       value="{{ if not .Images }}{{ .URL }}{{ end }}"
                       required autocomplete="off" {{ if not .Images }}autofocus{{ end }}>
                <button type="button" class="paste-btn" id="pasteBtn" onclick="pasteFromClipboard()" title="Paste from clipboard">
                    <i class="bi bi-clipboard"></i>
                </button>
                <button type="submit" class="btn btn-primary search-btn">
                    <i class="bi bi-arrow-right fs-5"></i>
                </button>
            </form>
        </div>
    </section>

    {{ if .Alert }}
    <div class="container mt-4">
        <div class="alert alert-{{ .Alert.Type }} border-0 shadow-sm d-flex align-items-center gap-3 rounded-4" role="alert">
            <i class="bi fs-4
                {{ if eq .Alert.Type "success" }}bi-check-circle-fill text-success
                {{- else if eq .Alert.Type "info" }}bi-info-circle-fill text-info
                {{- else if eq .Alert.Type "danger" }}bi-x-circle-fill text-danger
                {{- else }}bi-exclamation-triangle-fill text-warning{{ end }}"></i>
            <span>{{ .Alert.Message }}</span>
        </div>
    </div>
    {{ end }}

    {{ if .Images }}
    <form action="/download-zip" method="POST" id="galleryForm">
        <input type="hidden" name="page_title" value="{{ .Title }}">

        <div class="container">
            <div class="d-flex align-items-center justify-content-between mt-4 mb-2">
                <h5 class="text-secondary fw-normal mb-0">
                    <span id="countDisplay">{{ len .Images }}</span> images found
                </h5>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary rounded-pill px-3" onclick="selectAll()">Select All</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary rounded-pill px-3" onclick="deselectAll()">None</button>
                </div>
            </div>

            <div class="gallery-grid">
                {{ range $i, $url := .Images }}
                <div class="image-card selected" onclick="toggleSelection(this)">
                    <div class="check-badge"><i class="bi bi-check-lg"></i></div>
                    <input type="checkbox" name="image_urls" value="{{ $url }}" checked>
                    <img src="{{ $url }}" alt="Image {{ $i }}" loading="lazy">
                    <div class="card-actions" onclick="event.stopPropagation()">
                        <a href="{{ $url }}" target="_blank" rel="noopener"
                           class="btn btn-light btn-icon rounded-circle shadow-sm" title="View full size">
                            <i class="bi bi-arrows-fullscreen"></i>
                        </a>
                    </div>
                </div>
                {{ end }}
            </div>
        </div>

        <div class="action-bar visible" id="actionBar">
            <div class="d-flex align-items-center gap-2 border-end pe-3">
                <span class="fw-bold" id="selectedCount">{{ len .Images }}</span>
                <span class="text-secondary small d-none d-sm-inline">selected</span>
            </div>
            <select name="format" id="formatSelect"
                    class="form-select border rounded-pill bg-body-tertiary py-1 ps-3"
                    style="width:auto;cursor:pointer;">
                <option value="original">Original</option>
                <option value="jpg">JPG</option>
                <option value="png">PNG</option>
            </select>
            <button type="submit" id="downloadBtn"
                    class="btn btn-primary rounded-pill px-4 fw-bold d-flex align-items-center gap-2 text-nowrap">
                <i class="bi bi-download"></i>
                <span id="downloadText">Download</span>
            </button>
        </div>
    </form>
    {{ end }}

    {{ if not .Images }}
    <div class="text-center text-secondary opacity-25 mt-5 pt-5">
        <i class="bi bi-images display-1"></i>
    </div>
    {{ end }}

</main>

<script>
// Theme
function applyTheme(t) {
    document.documentElement.setAttribute('data-bs-theme', t);
    document.querySelector('#themeBtn i').className = t === 'dark' ? 'bi bi-moon-stars-fill' : 'bi bi-sun-fill';
}
function toggleTheme() {
    const next = document.documentElement.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark';
    localStorage.setItem('theme', next);
    applyTheme(next);
}
applyTheme(localStorage.getItem('theme') || 'dark');

// Loading
function showLoading() {
    document.activeElement?.blur();
    document.getElementById('loadingOverlay').style.display = 'flex';
}

// Paste
(function() {
    const btn = document.getElementById('pasteBtn');
    if (!btn) return;
    if (!navigator.clipboard?.readText) { btn.hidden = true; return; }
})();

async function pasteFromClipboard() {
    const input = document.getElementById('urlInput');
    const btn   = document.getElementById('pasteBtn');
    const icon  = btn.querySelector('i');
    try {
        input.value = (await navigator.clipboard.readText()).trim();
        input.focus();
        icon.className = 'bi bi-clipboard-check';
        btn.classList.add('success');
        setTimeout(() => { icon.className = 'bi bi-clipboard'; btn.classList.remove('success'); }, 1500);
    } catch { input.focus(); input.select(); }
}

// Gallery
const actionBar   = document.getElementById('actionBar');
const countSpan   = document.getElementById('selectedCount');
const downloadBtn = document.getElementById('downloadBtn');

function toggleSelection(card) {
    const cb = card.querySelector('input[type="checkbox"]');
    cb.checked = !cb.checked;
    card.classList.toggle('selected', cb.checked);
    syncBar();
}
function selectAll()   { document.querySelectorAll('.image-card').forEach(c => { c.querySelector('input').checked = true;  c.classList.add('selected');    }); syncBar(); }
function deselectAll() { document.querySelectorAll('.image-card').forEach(c => { c.querySelector('input').checked = false; c.classList.remove('selected'); }); syncBar(); }
function syncBar() {
    const n = document.querySelectorAll('input[name="image_urls"]:checked').length;
    if (countSpan)   countSpan.textContent = n;
    if (downloadBtn) downloadBtn.disabled = n === 0;
    if (actionBar)   actionBar.classList.toggle('visible', n > 0);
}

// Format label
const fmt = document.getElementById('formatSelect');
if (fmt) fmt.addEventListener('change', function() {
    document.getElementById('downloadText').textContent =
        this.value === 'original' ? 'Download' : `Download ${this.value.toUpperCase()}`;
});
</script>
</body>
</html>
